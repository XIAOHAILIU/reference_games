---
title: "sketchpad_basic"
output: html_document
---

# Import some libraries 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggthemes)
library(lme4)
library(stringr)
# # Note: to install langcog, 
# library(langcog)
library(jsonlite)
```

# Create BDA input

## Import group data

TODO: incorporate pilot0 as well (though missing pose data makes this nontrivial)

```{r}
raw <-  read_delim('sketchpad_basic_merged_group_data.csv', delim = ',') 
invalid_trials <- (read_csv('./invalid_trial_paths.txt', col_names = F) %>%
  mutate(X1 = gsub('gameID_', '', X1)) %>%
  mutate(X1 = gsub('trial_', '', X1)) %>%
  mutate(X1 = gsub('.png', '', X1)) %>%
  mutate(X1 = str_sub(gsub("-", "", X1), start = 25)))$X1


dogs <- c('weimaraner', 'chihuahua', 'basset', 'doberman', 'bloodhound', 'bullmastiff', 'goldenretriever', 'pug')
chairs = c('leather', 'straight', 'squat', 'sling', 'woven', 'waiting', 'inlay','knob')
birds = c('crow', 'pigeon', 'robin', 'sparrow', 'tomtit', 'nightingale', 'bluejay', 'cuckoo')
cars = c('beetle', 'bluesport', 'brown', 'white', 'redsport', 'redantique', 'hatchback', 'bluesedan')
d <- raw %>% 
  mutate(gameid = str_sub(gsub("-", "", gameID), start = -12)) %>%
  mutate(sketchLabel = sprintf('%s_%s', gameid, trialNum)) %>%
  filter(iteration == 'pilot1') %>% # Just use pilot 1 for now
  filter(!(sketchLabel %in% invalid_trials)) %>% # Remove invalid sketch (e.g. w/ text)
  filter(outcome == 1) %>% # Remove incorrect trials
  select(sketchLabel, condition, target, Distractor1, Distractor2, Distractor3, mean_intensity, pose) %>%
  mutate(domain = case_when(target %in% chairs ~ 'chair',
                            target %in% dogs ~ 'dog',
                            target %in% birds ~ 'bird',
                            target %in% cars ~ 'car',
                            T ~ 'other'))
```

```{r}
with_domain <- raw %>%
  mutate(domain = case_when(target %in% chairs ~ 'chair',
                            target %in% dogs ~ 'dog',
                            target %in% birds ~ 'bird',
                            target %in% cars ~ 'car',
                            T ~ 'other')) 
write_csv(with_domain %>% select(-X1, -`Unnamed: 0`), 'merged_data_plus_domain.csv')
```

Write out cost look-up table (use mean_intensity for now):

```{r}
as.list(setNames(d$mean_intensity,d$sketchLabel)) %>%
  write_json('RSA/refModule/json/costs.json')
```

We reorder contexts alphabetically because we just care about content of set. Also reformat object names to include pose.... 

```{r}
d$context = apply(d %>% select(Distractor1, Distractor2, Distractor3), 1, 
                  function(x) paste(sort(x), collapse="_"))

d.ordered = d %>% 
  select(-Distractor1, -Distractor2, -Distractor3) %>%
  separate(context, into = c('Distractor1', 'Distractor2', 'Distractor3')) %>%
  mutate(Target = sprintf("%s_%04d", target, pose)) %>%
  mutate(Distractor1 = sprintf("%s_%04d", Distractor1, pose)) %>%
  mutate(Distractor2 = sprintf("%s_%04d", Distractor2, pose)) %>%
  mutate(Distractor3 = sprintf("%s_%04d", Distractor3, pose))
```

Note: it'd be nicer if we had a smaller space of unique conditions for quicker BDA in webppl, but pretty much every trial was unique due to the pose randomization... 

Write out actual data to condition on

```{r}
d.ordered %>% 
  select(condition, sketchLabel, Target, Distractor1, Distractor2, Distractor3) %>%
  write_csv('./RSA/bdaInput/sketch_data.csv')
```

Make alternate dataset with only far condition

```{r}
d.ordered %>%  filter(condition == 'further') %>%
  select(condition, sketchLabel, Target, Distractor1, Distractor2, Distractor3) %>%
  write_csv('./RSA/bdaInput/sketch_data_far_only.csv')
```

# Analyze raw similarities

Load in different embeddings and make boilerplate iterables for them

```{r}
# strictSimilarities <- fromJSON('./RSA/refModule/json/strict-similarity.json', flatten = T)
# nonstrictSimilarities <- fromJSON('./RSA/refModule/json/nonstrict-similarity.json', flatten = T)
pragSimilarities <- fromJSON('./RSA/refModule/json/strict-similarity-pragmatics-conv4_2.json', flatten = T)

lookupFixedSimilarity <- function(object, sketch) {
  fixedSimilarities[[object]]
  return(fixedSimilarities[[object]][[sketch]])
}

lookupPragSimilarity <- function(object, sketch) {
  return(pragSimilarities[[object]][[sketch]])
}

lookupEarlySimilarity <- function(object, sketch) {
  return(earlySimilarities[[object]][[sketch]])
}
```

Add columns for the different kinds of similarity

```{r}
d.similarity <- d.ordered %>%
  gather(contextElement, name, Target, Distractor1, Distractor2, Distractor3) %>%
  rowwise() %>%
  mutate(pragSimilarity = lookupPragSimilarity(name, sketchLabel)) %>%
  rowwise() %>%
  mutate(fixedSimilarity = lookupFixedSimilarity(name, sketchLabel)) 
```

Sanity check: is similarity higher for target than distractors?

```{r}
tmp = d.similarity %>% 
  mutate(contextElement = case_when(contextElement == 'Target' ~ 'target',
                                    T ~ 'distractor')) %>%
  filter(condition == 'further') 

tmp %>%
  ggplot(aes(x = pragSimilarity, fill = contextElement)) +
    geom_density(alpha = .5) +
    theme_few() +
    theme(aspect.ratio = 1) +
    xlim(-1, 1) +
    ggtitle('sketch similarity in further condition') +
    facet_wrap(~ domain) +
    scale_fill_colorblind()

ggsave('diffconditions.pdf')
```

Yes,on 'far' conditions the sketch tends to be similar to the target and dissimilar to the distractors

What about closer condition? 

```{r}
tmp = d.similarity %>% 
  mutate(contextElement = case_when(contextElement == 'Target' ~ 'target',
                                    T ~ 'distractor')) %>%
  filter(condition == 'closer') 

tmp %>%
  ggplot(aes(x = pragSimilarity, fill = contextElement)) +
    geom_density(alpha = .5) +
    theme_few() +
    theme(aspect.ratio = 1) +
    xlim(-1, 1) +
    ggtitle('sketch similarity in close condition') +
    facet_wrap(~ domain) +
    scale_fill_colorblind()

ggsave('sameconditions.pdf')
```

On 'close' conditions the sketch tends to be similar to both...

What does the early layer look like?

```{r}
tmp = d.similarity %>% 
  mutate(contextElement = case_when(contextElement == 'Target' ~ 'target',
                                    T ~ 'distractor')) %>%
  filter(condition == 'further') 

tmp %>%
  ggplot(aes(x = earlySimilarity, fill = contextElement)) +
    geom_density(alpha = .5) +
    theme_few() +
    theme(aspect.ratio = 1) +
    xlim(-1, 1) +
    ggtitle('sketch similarity in further condition') +
    scale_fill_colorblind()

ggsave('early_far.pdf')
```

What does the early layer look like?

```{r}
tmp = d.similarity %>% 
  mutate(contextElement = case_when(contextElement == 'Target' ~ 'target',
                                    T ~ 'distractor')) %>%
  filter(condition == 'closer') 

tmp %>%
  ggplot(aes(x = earlySimilarity, fill = contextElement)) +
    geom_density(alpha = .5) +
    theme_few() +
    theme(aspect.ratio = 1) +
    xlim(-1, 1) +
    ggtitle('sketch similarity in closer condition') +
    scale_fill_colorblind()

ggsave('early_close.pdf')
```

But is anything different across conditions? We'd expect that your bird is pushed to look more like the target bird when the distractors are also birds... 

```{r}
wilcox.test(sketchSimilarity ~ condition, 
            data = d.similarity %>% filter(contextElement == 'Target'))

d.similarity %>% 
  filter(contextElement == 'Target') %>%
  separate(name, into = c('pureName', 'poseStr')) %>% #  = strsplit(name, split = '_')[0]) 
  group_by(condition, pureName) %>%
  summarize(m = mean(sketchSimilarity)) %>%
  spread(condition, m) %>%
  ggplot(aes(x = closer, y = further, label = pureName)) +
    # geom_point() +
    # geom_abline(slope = 1, intercept = 0) +
    geom_text(check_overlap = T) +
    theme_few() +
    theme(aspect.ratio = 1) +
    ggtitle('sketch similarity to target across conditions')
```

Not with this embedding... 

Correlation b/w embeddings at trial-by-trial level

```{r}
d.similarity %>% 
  filter(contextElement == 'Target') %>%
  separate(name, into = c('pureName', 'poseStr')) %>% #  = strsplit(name, split = '_')[0]) 
  #gather(embedding, similarity, strictSimilarity,nonstrictSimilarity) %>%
  # group_by(embedding, pureName) %>%
  # summarize(m = mean(sketchSimilarity)) %>%
  # spread(condition, m) %>%
  ggplot(aes(x = strictSimilarity, y = nonstrictSimilarity)) +#, label = pureName)) +
    geom_bin2d() +
    # geom_abline(slope = 1, intercept = 0) +
    #geom_text(check_overlap = T) +
    theme_few() +
    theme(aspect.ratio = 1) +
    ggtitle('sketch similarity to target across conditions')
```

Correlation b/w embeddings at item level

```{r}
d.similarity %>% 
  filter(contextElement == 'Target') %>%
  separate(name, into = c('pureName', 'poseStr')) %>% #  = strsplit(name, split = '_')[0]) 
  gather(embedding, similarity, strictSimilarity,nonstrictSimilarity) %>%
  group_by(embedding, pureName) %>%
  summarize(m = mean(similarity)) %>%
  spread(embedding, m) %>%
  ggplot(aes(x = strictSimilarity, y = nonstrictSimilarity, label = pureName)) +
    #geom_smooth(method = 'loess') +
    geom_text(check_overlap = T) +
    geom_abline(slope = 1, intercept = 0) +
    #geom_text(check_overlap = T) +
    theme_few() +
    theme(aspect.ratio = 1) +
    xlim(-.2, 1) +
  ylim(-.2, 1) +
    ggtitle('sketch similarity to target across embeddings')
```

# Model comparison

Compute likelihood for each model... 

```{r}
sumlogprob <- function(a, b) {
  if(a>b) {
    return(a+log1p(exp(b-a)))
  } else{
    return(b+log1p(exp(a-b)))
  }
}

modelOutput = read_csv('./RSA/bdaOutput/testingParams.csv') %>%
  #filter(posteriorProb != -Inf) %>%
  group_by(embedding,speakerModel) %>%
  summarize(prob = reduce(logLikelihood, sumlogprob) - log(length(logLikelihood)))

print(modelOutput)
```

Visualize as bars

```{r}
ggplot(modelOutput, aes(x = embedding, y = prob, fill = speakerModel)) +
    geom_bar(stat = 'identity', position = 'dodge', width = .75) +
    guides(fill=guide_legend(title="Speaker model")) +
    ylab('log-likelihood') +
    scale_fill_colorblind() +
    theme_few(12) +
    theme(aspect.ratio = )
    coord_cartesian(ylim=c(-10100, -9500)) +
    theme(legend.position = 'top') 

ggsave('modelComparison.pdf')
```

```{r}
samples = read_csv('./RSA/bdaOutput/testingParams.csv') %>%
  filter(speakerModel == 'S1' & embedding == 'nonstrict-high') %>%
  filter(posteriorProb != "-Infinity") %>%
  mutate(posteriorProb = as.numeric(posteriorProb)) %>%
  mutate(intermed = exp(posteriorProb - max(posteriorProb))) %>%
  mutate(posteriorProb = log(intermed/sum(intermed))) %>%
  select(-intermed, -speakerModel, -embedding) 

  mutate(MCMCprob = exp(MCMCprob)) %>%
  filter(MCMCprob > 0.001) %>%
  mutate(n = floor(MCMCprob*1000)) %>%
  do(data.frame(.[rep(1:nrow(.), .$n),])) %>%
  select(-t, -n, -MCMCprob) %>%
  gather(parameter, value) %>%
  mutate(value = as.numeric(as.character( value)))
```
 
```{r}
fixedSimilarities <- fromJSON('./RSA/refModule/json/strict-similarity-pragmatics-fixedpose-conv4_2.json', flatten = T)

raw_fixed <- read_delim('sketchpad_basic_pilot2_group_data.csv', delim = ',') 

d <- raw_fixed %>% 
  mutate(gameid = str_sub(gsub("-", "", gameID), start = -12)) %>%
  mutate(sketchLabel = sprintf('%s_%s', gameid, trialNum)) %>%
  select(sketchLabel, condition, target, Distractor1, Distractor2, Distractor3, mean_intensity, pose) 
```

```{r}
d$context = apply(d %>% select(Distractor1, Distractor2, Distractor3), 1, 
                  function(x) paste(sort(x), collapse="_"))

test_trials <- (read_csv('./pilot2_test_examples.txt', col_names = F) %>%
  mutate(X1 = gsub('gameID_', '', X1)) %>%
  mutate(X1 = gsub('trial_', '', X1)) %>%
  #mutate(X1 = gsub('.png', '', X1)) %>%
  mutate(X1 = str_sub(gsub("-", "", X1), start = 25)) %>%
  separate())$X1


d.ordered = d %>% 
  select(-Distractor1, -Distractor2, -Distractor3) %>%
  separate(context, into = c('Distractor1', 'Distractor2', 'Distractor3')) %>%
  mutate(Target = sprintf("%s_%04d", target, pose)) %>%
  mutate(Distractor1 = sprintf("%s_%04d", Distractor1, pose)) %>%
  mutate(Distractor2 = sprintf("%s_%04d", Distractor2, pose)) %>%
  mutate(Distractor3 = sprintf("%s_%04d", Distractor3, pose))

as.list(setNames(d$mean_intensity,d$sketchLabel)) %>%
  write_json('RSA/refModule/json/costs.json')

# Only keep close trials from held-out set
d.ordered %>% 
  select(condition, sketchLabel, Target, Distractor1, Distractor2, Distractor3) %>%
  
  write_csv('./RSA/bdaInput/sketch_data.csv')
```